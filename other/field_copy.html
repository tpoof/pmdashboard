<script>
(function () {
  function findInput(indicatorId) {
    // Common LEAF patterns; keep the first match that exists.
    var candidates = [
      '[data-indicator-id="' + indicatorId + '"] textarea',
      '[data-indicator-id="' + indicatorId + '"] input, [data-indicator-id="' + indicatorId + '"] textarea',
      '#indicator' + indicatorId + ' textarea',
      '#indicator' + indicatorId + ' input, #indicator' + indicatorId + ' textarea',
      '#indicator_' + indicatorId + ' textarea',
      '#indicator_' + indicatorId + ' input, #indicator_' + indicatorId + ' textarea',
      '#indicatorID' + indicatorId + ' textarea',
      '#indicatorID' + indicatorId + ' input, #indicatorID' + indicatorId + ' textarea'
    ];
    for (var i = 0; i < candidates.length; i++) {
      var el = document.querySelector(candidates[i]);
      if (el) return el;
    }
    // Fallback: scan inputs/textareas for indicator ID in name/id
    var nodes = document.querySelectorAll('input, textarea');
    var needle = String(indicatorId);
    for (var j = 0; j < nodes.length; j++) {
      var n = nodes[j];
      var name = (n.getAttribute('name') || '').toLowerCase();
      var id = (n.getAttribute('id') || '').toLowerCase();
      if (
        name.includes('indicator') || id.includes('indicator') ||
        name.includes('indicatorid') || id.includes('indicatorid')
      ) {
        if (
          name.includes('indicatorid[' + needle + ']') ||
          name.includes('indicatorid:' + needle) ||
          name.includes('indicatorid_' + needle) ||
          name.includes('indicator' + needle) ||
          id.includes('indicatorid' + needle) ||
          id.includes('indicator_' + needle) ||
          id.includes('indicator' + needle)
        ) {
          return n;
        }
      }
    }
    return null;
  }

  function copyValue() {
    var from = findInput(1);
    var to = findInput(2);
    if (!from || !to) return;
    to.value = from.value || '';
    // Trigger change/input in case LEAF listens to events
    to.dispatchEvent(new Event('input', { bubbles: true }));
    to.dispatchEvent(new Event('change', { bubbles: true }));
  }

  function init() {
    var lastValue = null;

    function tryBind() {
      var from = findInput(1);
      var to = findInput(2);
      if (!from || !to) return false;

      // Initial sync
      copyValue();

      // Keep synced on user input or programmatic changes that trigger input/change
      from.addEventListener('input', copyValue);
      from.addEventListener('change', copyValue);

      // Poll to catch programmatic updates that don't emit events
      setInterval(function () {
        if (!from || !to) return;
        if (from.value !== lastValue) {
          lastValue = from.value;
          to.value = from.value || '';
          to.dispatchEvent(new Event('input', { bubbles: true }));
          to.dispatchEvent(new Event('change', { bubbles: true }));
        }
      }, 400);

      return true;
    }

    // Try immediately and then a few times in case LEAF renders late
    if (tryBind()) return;
    var attempts = 0;
    var timer = setInterval(function () {
      attempts += 1;
      if (tryBind() || attempts > 30) clearInterval(timer);
    }, 300);
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();

(function () {
  "use strict";

  if (window.__leafAutoReloadAfterSubmitInstalled) return;
  window.__leafAutoReloadAfterSubmitInstalled = true;

  var RELOAD_DELAY_MS = 1200;

  function looksLikeSubmitButton(el) {
    if (!el) return false;
    var tag = (el.tagName || "").toLowerCase();
    if (tag !== "button" && !(tag === "input" && (el.type === "button" || el.type === "submit"))) return false;

    var label = (el.innerText || el.value || "").trim().toLowerCase();
    return label.includes("submit") || label.includes("save");
  }

  function hasObviousErrorUI() {
    // Best-effort selectors for common error patterns
    return Boolean(
      document.querySelector(".alert-danger, .alert-error, .error, .has-error, .text-danger") ||
      Array.from(document.querySelectorAll(".alert, .toast, .notification, .message")).some(function (n) {
        var t = (n.textContent || "").toLowerCase();
        return t.includes("error") || t.includes("failed") || t.includes("invalid");
      })
    );
  }

  function scheduleReload() {
    var startUrl = String(window.location.href);

    setTimeout(function () {
      try {
        // If navigation already happened, do nothing
        if (String(window.location.href) !== startUrl) return;

        // If an error UI is present, do not reload
        if (hasObviousErrorUI()) return;

        window.location.reload();
      } catch (e) {}
    }, RELOAD_DELAY_MS);
  }

  // Capture very early, before app code runs
  document.addEventListener(
    "pointerdown",
    function (e) {
      var btn = e.target && e.target.closest ? e.target.closest("button, input[type='button'], input[type='submit']") : null;
      if (looksLikeSubmitButton(btn)) scheduleReload();
    },
    true
  );

  document.addEventListener(
    "click",
    function (e) {
      var btn = e.target && e.target.closest ? e.target.closest("button, input[type='button'], input[type='submit']") : null;
      if (looksLikeSubmitButton(btn)) scheduleReload();
    },
    true
  );
})();
</script>
