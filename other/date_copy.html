<script>
  (function () {
    "use strict";

    // Copy from indicator 1 to indicator 2
    var START_SEL = 'input[name="1"]';
    var TARGET_SEL = 'input[name="2"]';

    function notify(el) {
      if (!el) return;
      el.dispatchEvent(new Event("input", { bubbles: true }));
      el.dispatchEvent(new Event("change", { bubbles: true }));

      if (window.jQuery && window.jQuery.fn && window.jQuery.fn.datepicker) {
        try { window.jQuery(el).datepicker("setDate", el.value); } catch (e) {}
      }
    }

    function copyDate() {
      var startEl = document.querySelector(START_SEL);
      var targetEl = document.querySelector(TARGET_SEL);
      if (!startEl || !targetEl) return;
      if (!startEl.value) return;

      targetEl.value = startEl.value;
      notify(targetEl);
    }

    function hookStartInput() {
      var startEl = document.querySelector(START_SEL);
      if (!startEl) return;

      startEl.addEventListener("change", copyDate, true);
      startEl.addEventListener("blur", copyDate, true);

      if (window.jQuery && window.jQuery.fn && window.jQuery.fn.datepicker) {
        try {
          var $ = window.jQuery;
          var $start = $(startEl);

          var existing = null;
          try { existing = $start.datepicker("option", "onSelect"); } catch (e) {}

          try {
            $start.datepicker("option", "onSelect", function (dateText, inst) {
              try { if (typeof existing === "function") existing.call(this, dateText, inst); } catch (e) {}
              copyDate();
            });
          } catch (e) {}
        } catch (e) {}
      }
    }

    function isSubmitEndpoint(url) {
      try {
        var u = new URL(url, window.location.origin);
        return /\/api\/form\/\d+\/submit\/?$/.test(u.pathname);
      } catch (e) {
        return /\/api\/form\/\d+\/submit\/?/.test(String(url || ""));
      }
    }

    function hookSubmitClicks() {
      document.addEventListener("pointerdown", copyDate, true);

      document.addEventListener("click", function (e) {
        var t = e.target;
        if (!t) return;
        if (t.matches('button, input[type="button"], input[type="submit"]')) {
          var label = (t.innerText || t.value || "").toLowerCase();
          if (label.includes("submit") || label.includes("save")) {
            copyDate();
          }
        }
      }, true);
    }

    function hookFetchAndXHRForRefresh() {
      if (window.fetch && !window.fetch.__leafDateCopyHooked) {
        var origFetch = window.fetch;
        window.fetch = function (input, init) {
          var url = (typeof input === "string") ? input : (input && input.url);

          try { if (url && isSubmitEndpoint(url)) copyDate(); } catch (e) {}

          return origFetch.apply(this, arguments).then(function (resp) {
            try {
              if (url && isSubmitEndpoint(url) && resp && resp.ok) {
                setTimeout(function () {
                  try { window.location.reload(); } catch (e) {}
                }, 250);
              }
            } catch (e) {}
            return resp;
          });
        };
        window.fetch.__leafDateCopyHooked = true;
      }

      if (window.XMLHttpRequest && !window.XMLHttpRequest.__leafDateCopyHooked) {
        var OriginalXHR = window.XMLHttpRequest;

        function WrappedXHR() {
          var xhr = new OriginalXHR();
          var originalOpen = xhr.open;
          var originalSend = xhr.send;

          xhr.open = function (method, url) {
            xhr.__leafUrl = url;
            return originalOpen.apply(xhr, arguments);
          };

          xhr.send = function (body) {
            try {
              if (xhr.__leafUrl && isSubmitEndpoint(xhr.__leafUrl)) {
                copyDate();
                xhr.addEventListener("load", function () {
                  try {
                    if (xhr.status >= 200 && xhr.status < 300) {
                      setTimeout(function () {
                        try { window.location.reload(); } catch (e) {}
                      }, 250);
                    }
                  } catch (e) {}
                });
              }
            } catch (e) {}
            return originalSend.apply(xhr, arguments);
          };

          return xhr;
        }

        WrappedXHR.prototype = OriginalXHR.prototype;
        window.XMLHttpRequest = WrappedXHR;
        window.XMLHttpRequest.__leafDateCopyHooked = true;
      }
    }

    function init() {
      hookStartInput();
      hookSubmitClicks();
      hookFetchAndXHRForRefresh();
      copyDate();
    }

    if (document.readyState === "loading") {
      document.addEventListener("DOMContentLoaded", init);
    } else {
      init();
    }
  })();
</script>
